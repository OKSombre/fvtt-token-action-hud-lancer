const e="token-action-hud-lancer",t={weapon:"tokenActionHud.lancer.weapon"},s={attacks:{id:"attacks",name:"tokenActionHud.lancer.attacks",type:"system"},bonds:{id:"bonds",name:"tokenActionHud.lancer.bonds",type:"system"},combat:{id:"combat",name:"tokenActionHud.lancer.combat",type:"system"},coreBonuses:{id:"core-bonuses",name:"tokenActionHud.lancer.coreBonuses",type:"system"},corePower:{id:"core-power",name:"tokenActionHud.lancer.corePower",type:"system"},deployables:{id:"deployables",name:"tokenActionHud.lancer.deployables",type:"system"},grit:{id:"grit",name:"tokenActionHud.lancer.grit",type:"system"},hase:{id:"hase",name:"tokenActionHud.lancer.hase",type:"system"},mechWeapons:{id:"mech-weapons",name:"tokenActionHud.lancer.mechWeapons",type:"system"},pilotGear:{id:"pilot-gear",name:"tokenActionHud.lancer.pilotGear",type:"system"},pilotWeapons:{id:"pilot-weapons",name:"tokenActionHud.lancer.pilotWeapons",type:"system"},repair:{id:"repair",name:"tokenActionHud.lancer.repair",type:"system"},skillTriggers:{id:"skill-triggers",name:"tokenActionHud.lancer.skillTiggers",type:"system"},statuses:{id:"statuses",name:"tokenActionHud.lancer.status",type:"system"},systems:{id:"systems",name:"tokenActionHud.lancer.systems",type:"system"},talents:{id:"talents",name:"tokenActionHud.lancer.talents",type:"system"},techs:{id:"techs",name:"tokenActionHud.lancer.techs",type:"system"},traits:{id:"traits",name:"tokenActionHud.lancer.traits",type:"system"},weaponMods:{id:"weapon-mods",name:"tokenActionHud.lancer.weapon-mods",type:"system"}},n="deployable",o="mech",i="npc",a="npc_feature",l="mech_system",c="mech_weapon",r="pilot",d={npc_feature:{groupId:"mech-weapons"},mech_wepon:{groupId:"mech-weapons"},pilot_weapon:{groupId:"pilot-weapons"}};let p=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{p=class ActionHandler extends e.api.ActionHandler{actors=null;tokens=null;actorType=null;items=null;showDestroyedItems=null;showItemsWithoutActivations=null;showItemsWithoutUses=null;showNpcFeaturesWithoutActivations=null;showUnchargedNpcFeatures=null;showUnequippedItems=null;showUnloadedWeapons=null;showUsedCorePower=null;activationgroupIds=null;systemGroupIds=null;npcFeatureIds=null;featureActions=null;inventoryActions=null;spellActions=null;async buildSystemActions(t){if(this.actors=this.actor?[this.actor]:this.#e(),this.tokens=this.token?[this.token]:this.#t(),this.actorType=this.actor?.type,this.actor){let t=this.actor.items;t=e.api.Utils.sortItemsByName(t),this.items=t}switch(this.activationgroupIds=["quick-actions","full-actions","reactions","protocols","free-actions","quick-tech","full-tech"],this.systemGroupIds=["actions","deployables","techs"],this.npcFeatureIds=["techs","systems","weapons","traits"],this.actorType){case o:this.#s();break;case r:this.#n();break;case i:this.#o();break;case n:this.#i()}this.actor||this.#a()}#i(){}#s(){this.#l()}#a(){}#o(){this.#l()}#n(){}#c(){if(0===this.tokens?.length)return;const s="status",n=CONFIG.statusEffects.filter((e=>""!==e.id));if(0===n.length)return;const o=n.map((n=>{const o=n.id,i=e.api.Utils.i18n(n.label)??n.name,a=`${`${e.api.Utils.i18n(t[s])}: `??""}${i}`,l=[s,o].join(this.delimiter),c=this.actors.every((e=>game.version.startsWith("11")?e.effects.some((e=>e.statuses.some((e=>e===o))&&!e?.disabled)):e.effects.some((e=>e.flags?.core?.statusId===o&&!e?.disabled))))?" active":"",r=`toggle${c}`,d=e.api.Utils.getImage(n);return{id:o,name:i,encodedValue:l,img:d,cssClass:r,listName:a}}));this.addActions(o,{id:"statuses",type:"system"})}#l(){if(0===this.items.size)return;const s="weapon",n=new Map;for(const[e,t]of this.items){const s=t.type;if(this.#r(t)&&t.is_weapon()){const o=n.get(s)??new Map;o.set(e,t),n.set(s,o)}}for(const[o,i]of n){const n=d[o]?.groupId;if(!n)continue;const a={id:n,type:"system"},l=[...i].map((([n,o])=>{const i=n,a=o.name,l=e.api.Utils.i18n(t[s]),c=`${l?`${l}: `:""}${a}`,r=[s,i].join(this.delimiter);return{id:i,name:a,listName:c,encodedValue:r}}));this.addActions(l,a)}}#e(){const t=["deployable","mech","npc","pilot"],s=e.api.Utils.getControlledTokens()?.filter((e=>e.actor)).map((e=>e.actor));return s.every((e=>t.includes(e.type)))?s:[]}#t(){const t=["deployable","mech","npc","pilot"],s=e.api.Utils.getControlledTokens(),n=s?.filter((e=>e.actor)).map((e=>e.actor));return n.every((e=>t.includes(e.type)))?s:[]}#r(e){switch(e.type){case a:if(!this.showUnchargedNpcFeatures&&e.isRecharge()&&!e.system.charged)return!1;case l:case c:if(!this.showUnloadedWeapons&&e.isLoading()&&!e.system.loaded)return!1;if(!this.showItemsWithoutUses&&e.isLimited()&&!e.system.uses.value)return!1;if(!this.showDestroyedItems||e.system.destroyed)return!1;default:if(!this.showUnequippedItems&&!e.system.equipped)return!1}return!0}}}));const u=await import("../../token-action-hud-core/scripts/token-action-hud-core.min.js"),m=u.ActionHandler,y=u.ActionListExtender,h=u.CategoryManager,g=u.PreRollHandler,A=u.RollHandler,k=u.SystemManager,w=u.Utils,I=u.Logger;let b=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{b=class RollHandler extends e.api.RollHandler{async handleActionClick(e,t){const[s,n]=t.split(this.delimiter);if(["weapon"].includes(s)&&this.isRenderItem())return this.doRenderItem(this.actor,n);const o=["pilot","npc","mech","deployable"];if(this.actor)return void await this.#d(e,this.actor,this.token,s,n);const i=canvas.tokens.controlled.filter((e=>o.includes(e.actor?.type)));for(const t of i){const o=t.actor;await this.#d(e,o,t,s,n)}}async handleActionHover(e,t){}async handleGroupClick(e,t){}async#d(e,t,s,n,o){if("weapon"===n)this.#p(e,t,o)}#u(e,t,s){t.items.get(s).toChat(e)}async#m(e,t){if("endTurn"===t)game.combat?.current?.tokenId===e.id&&await(game.combat?.nextTurn())}#p(e,t,s){t.items.get(s).beginWeaponAttackFlow()}}}));let H=null;function register(e){}Hooks.once("tokenActionHudCoreApiReady",(async e=>{const t=s;Object.values(t).forEach((t=>{t.name=e.api.Utils.i18n(t.name),t.listName=`Group: ${e.api.Utils.i18n(t.listName??t.name)}`}));const n=Object.values(t);H={layout:[{nestId:"pilot",id:"pilot",name:e.api.Utils.i18n("tokenActionHud.lancer.pilot"),groups:[{...t.skillTriggers,nestId:"pilot_skill-triggers"},{...t.grit,nestId:"pilot_grit"},{...t.talents,nestId:"pilot_talents"},{...t.pilotGear,nestId:"pilot_pilot-gear"},{...t.pilotWeapons,nestId:"pilot_pilot-weapons"},{...t.bonds,nestId:"pilot_bonds"}]},{nestId:"mech",id:"mech",name:e.api.Utils.i18n("tokenActionHud.lancer.mech"),groups:[{...t.hase,nestId:"mech_hase"},{...t.coreBonuses,nestId:"mech_core-bonuses"},{...t.corePower,nestId:"mech_core-power"},{...t.traits,nestId:"mech_traits"}]},{nestId:"weapon",id:"weapon",name:e.api.Utils.i18n("tokenActionHud.lancer.weapon"),groups:[{...t.integratedMounts,nestId:"weapon_integrated-mounts"},{...t.mount1,nestId:"weapon_mount-1"},{...t.mount2,nestId:"weapon_mount-2"},{...t.mount3,nestId:"weapon_mount-3"},{...t.attacks,nestId:"weapon_attacks"}]},{nestId:"system",id:"system",name:e.api.Utils.i18n("tokenActionHud.lancer.system"),groups:[{...t.techs,nestId:"system_techs"},{...t.systems,nestId:"system_systems"},{...t.deployables,nestId:"system_deployables"}]},{nestId:"utility",id:"utility",name:e.api.Utils.i18n("tokenActionHud.lancer.utility"),groups:[{...t.combat,nestId:"utility_combat"},{...t.repair,nestId:"utility_repair"}]},{nestId:"status",id:"status",name:e.api.Utils.i18n("tokenActionHud.lancer.status"),groups:[{...t.statuses,nestId:"status_statuses"}]}],groups:n}}));let f=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{f=class SystemManager extends t.api.SystemManager{getActionHandler(){return new p}getAvailableRollHandlers(){return{core:"Core LANCER"}}getRollHandler(e){let t;return t=new b,t}async registerDefaults(){return H}registerSettings(e){}registerStyles(){return{template:{class:"tah-style-lancer-style",file:"tah-lancer-style",moduleId:e,name:"LANCER Style"}}}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const t=game.modules.get(e);t.api={requiredCoreModuleVersion:"1.5",SystemManager:f},Hooks.call("tokenActionHudSystemReady",t)}));export{p as ActionHandler,m as CoreActionHandler,y as CoreActionListExtender,h as CoreCategoryManager,g as CorePreRollHandler,A as CoreRollHandler,k as CoreSystemManager,w as CoreUtils,I as Logger,b as RollHandler,f as SystemManager,register};
