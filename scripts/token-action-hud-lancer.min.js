const e=await import("../../token-action-hud-core/scripts/token-action-hud-core.min.js"),t=e.ActionHandler,a=e.ActionListExtender,i=e.CategoryManager,r=e.PreRollHandler,n=e.RollHandler,o=e.SystemManager,s=e.Utils,c=e.Logger;class ActionHandler extends t{actor=null;actors=null;actorId=null;actorType=null;character=null;token=null;tokenId=null;mm=null;async buildSystemActions(e,t){if(this.actor=e?.actor,this.token=e?.token,this.token&&this.actor)switch(this.actorId=this.actor.id,this.actorType=this.actor.type,this.tokenId=this.token.id,this.mm=await this.actor.system.derived.mm,this.actorType){case"pilot":this._buildPilotCategory(this.mm);break;case"mech":this._buildPilotCategory(this.mm.Pilot)}}_buildPilotCategory(e){this._buildSkillsTriggersSubCategory(e),this._buildGritSubCategory(e),this._buildTalentsSubCategory(e)}_makeAction(e,t,a,i,r){return{name:e,encodedValue:[t,a,i,JSON.stringify(r||{})].join(this.delimiter)}}_makeActionsFromItems(e,t,a){return a.filter((e=>{if(null!=e)return e.Type===t})).map((t=>this._makeAction(t.Name,"item",e,t.RegistryID)))}_makeNPCItemSubCat(e,t,a,i){let r=this.initializeEmptySubcategory();return r.name=e,r.actions=a.items.filter((e=>{if(null!=e)return"npc_feature"===e.type})).filter((e=>e.system.type===t)).map((e=>this._makeAction(e.name,"item",i,e.id))),r}_pilotCategory(){return result}_npcBaseCategory(e,t){let a=this.initializeEmptyCategory("mech");return[this._haseSubCategory(t)].forEach((e=>{this._combineSubcategoryWithCategory(a,e.name,e)})),a}_npcFeatureCategory(e,t){let a=this.initializeEmptyCategory("feature");return[this._npcWeaponSubCat(e,t),this._npcTechSubCat(e,t),this._npcReactionSubCat(e,t),this._npcSystemSubCat(e,t),this._npcTraitSubCat(e,t)].forEach((e=>{this._combineSubcategoryWithCategory(a,e.name,e)})),a}_npcWeaponSubCat(e,t){let a=this._makeNPCItemSubCat(s.i18n("tokenActionHud.weapons"),"Weapon",e,t),i=this._makeAction(s.i18n("tokenActionHud.lancer.basicAttack"),"stat",t,"basicattack");return a.actions.push(i),a}_npcTraitSubCat(e,t){return this._makeNPCItemSubCat(s.i18n("tokenActionHud.traits"),"Trait",e,t)}_npcSystemSubCat(e,t){return this._makeNPCItemSubCat(s.i18n("tokenActionHud.lancer.systems"),"System",e,t)}_npcTechSubCat(e,t){let a=this._makeNPCItemSubCat(s.i18n("tokenActionHud.lancer.techs"),"Tech",e,t),i=this._makeAction(s.i18n("tokenActionHud.lancer.techAttack"),"stat",t,"techattack");return a.actions.push(i),a}_npcReactionSubCat(e,t){return this._makeNPCItemSubCat(s.i18n("tokenActionHud.reactions"),"Reaction",e,t)}_buildSkillsTriggersSubCategory(e){let t=e.RegistryID;const a=this._makeActionsFromItems(t,"skill",e._skills);this.addActionsToActionList(a,{id:"skill-triggers",type:"system"})}_buildGritSubCategory(e){let t=e.RegistryID;const a=[this._makeAction(s.i18n("tokenActionHud.lancer.grit"),"stat",t,"Grit")];this.addActionsToActionList(a,{id:"grit",type:"system"})}_buildTalentsSubCategory(e){let t=e.RegistryID,a={id:"talents",type:"system",hasDerivedSubcategories:!0};e._talents.filter((e=>{if(null!=e)return"talent"===e.Type})).map((e=>{console.log(e.Name);const i={id:`pilot-talent-${e.RegistryID}`,name:e.Name,type:"system-derived"};console.log(i),this.addSubcategoryToActionList(a,i);const r=[];for(let a=0;a<e.CurrentRank;a++){let i={rank:`${a}`};console.log(e.Ranks[a].Name),r.push(this._makeAction(`${s.i18n("tokenActionHud.lancer.rank")} ${a+1}: ${e.Ranks[a].Name}`,"item",t,e.RegistryID,i))}this.addActionsToActionList(r,i)}))}_pilotWeaponSubCategory(e,t){return this._makeItemSubCat(s.i18n("tokenActionHud.weapons"),"pilot_weapon",e.Loadout.Weapons,t)}_pilotGearSubCategory(e,t){return this._makeItemSubCat(s.i18n("tokenActionHud.lancer.gear"),"pilot_gear",e.Loadout.Gear,t)}_mechCategory(e,t){let a=this.initializeEmptyCategory("mech");return[this._haseSubCategory(t),this._frameSubCategory(e,t),this._coreBonSubCategory(e,t),this._corePowerSubCategory(e.Loadout.Frame,t)].forEach((e=>{this._combineSubcategoryWithCategory(a,e.name,e)})),a}_haseSubCategory(e){let t=this.initializeEmptySubcategory();t.id="hase",t.name=s.i18n("tokenActionHud.lancer.hase");let a=[{name:s.i18n("tokenActionHud.lancer.hull"),id:"Hull"},{name:s.i18n("tokenActionHud.attribute.agility"),id:"Agi"},{name:s.i18n("tokenActionHud.lancer.systems"),id:"Sys"},{name:s.i18n("tokenActionHud.lancer.engineering"),id:"Eng"}].map((t=>this._makeAction(t.name,"hase",e,t.id)));return t.actions=a,t}_basicSubCategory(e){let t=this.initializeEmptySubcategory();t.id="stat",t.name=s.i18n("tokenActionHud.lancer.basic");let a=[{name:s.i18n("tokenActionHud.lancer.basicAttack"),data:"basicattack"},{name:s.i18n("tokenActionHud.lancer.techAttack"),data:"techattack"}].map((t=>this._makeAction(t.name,"stat",e,t.data)));return t.actions=a,t}_frameSubCategory(e,t){let a=this.initializeEmptySubcategory(),i=["+1","+1d3","+1d6","+1d6 + 4"],r=Math.min(e.OverchargeCount,i.length-1);a.id="frame",a.name=s.i18n("tokenActionHud.lancer.frame");let n=s.i18n("tokenActionHud.lancer.overcharge")+" ("+i[r]+")";return a.actions=[this._makeAction(n,"frame",t,"overcharge"),this._makeAction(s.i18n("tokenActionHud.lancer.stabilize"),"frame",t,"stabilize")],a}_coreBonSubCategory(e,t){let a=this.initializeEmptySubcategory(),i=e.Pilot.CoreBonuses;return a.name="Core Bonuses",a.actions=i.map((a=>{let i={};return i.pilot=e.Pilot.RegistryID,this._makeAction(a.Name,"coreBonus",t,a.RegistryID,i)})),a}_corePowerSubCategory(e,t){let a=this.initializeEmptySubcategory(),i=e.CoreSystem;return a.name=i.Name,"Core Passive"!=i.PassiveName&&a.actions.push(this._makeAction(i.PassiveName,"corePassive",t,"")),i.ActiveName&&a.actions.push(this._makeAction(i.ActiveName,"coreActive",t,"")),a}_weaponsCategory(e,t){let a=this.initializeEmptyCategory();a.id="weapons",a.name=s.i18n("tokenActionHud.weapons");let i=e.map(((e,a)=>{let i=this.initializeEmptySubcategory("Mount_"+a);return i.name=e.MountType,i.actions=e.Slots.filter((e=>null!==e.Weapon)).map((e=>this._makeAction(e.Weapon.Name,"item",t,e.Weapon.RegistryID))),i}));return i=[this._basicSubCategory(t)].concat(i),i.forEach((e=>{this._combineSubcategoryWithCategory(a,e.name,e)})),a}_systemsCategory(e,t){let a=this.initializeEmptyCategory();return a.id="systems",a.name=s.i18n("tokenActionHud.lancer.systems"),e.flatMap((e=>e.System)).map((e=>{let a=this.initializeEmptySubcategory(e.RegistryID);a.name=e.Name;let i=e.Actions.map(((a,i)=>{let r={Type:"Action"};return r.Index=i,this._makeAction(a.Name,"activation",t,e.RegistryID,r)})),r=e.Deployables.map(((a,i)=>{let r={Type:"Deployable"};return r.Index=i,this._makeAction(a.Name,"activation",t,e.RegistryID,r)}));return a.actions=i.concat(r),a})).forEach((e=>{this._combineSubcategoryWithCategory(a,e.name,e)})),a}}class RollHandler extends n{doHandleActionEvent(e,t){let a=t.split("|");3!=a.length&&4!=a.length&&super.throwInvalidValueErr();let i=a[0],r=a[1],n=a[2],o=JSON.parse(a[3]);if(this.isRenderItem()&&["item"].includes(i))return this.doRenderItem(r,n);switch(i){case"hase":this._rollHaseMacro(r,n);break;case"stat":"techattack"==n?this._rollTechMacro(r):"basicattack"==n?this._rollBasicAttackMacro():this._rollStatMacro(r,n);break;case"frame":"stabilize"==n?this._promptStabilizeMacro(r):this._rollOverchargeMacro(r);break;case"item":this._rollWeaponOrFeatureMacro(r,n,o);break;case"coreBonus":this._rollCoreBonusMacro(o.pilot,n);break;case"coreActive":this._rollCoreActiveMacro(r);break;case"corePassive":this._rollCorePassiveMacro(r);break;case"activation":this._rollActivationMacro(r,n,o)}}_rollHaseMacro(e,t){game.lancer.prepareStatMacro(e,`mm.${t}`)}_rollStatMacro(e,t){console.log(t),game.lancer.prepareStatMacro(e,`mm.${t}`)}_rollTechMacro(e){game.lancer.prepareTechMacro(e,null)}_rollBasicAttackMacro(){game.lancer.prepareEncodedAttackMacro()}_promptStabilizeMacro(e){game.lancer.stabilizeMacro(e)}_rollOverchargeMacro(e){game.lancer.prepareOverchargeMacro(e)}_rollWeaponOrFeatureMacro(e,t,a){game.lancer.prepareItemMacro(e,t,a)}_rollCoreBonusMacro(e,t){game.lancer.prepareItemMacro(e,t)}_rollCoreActiveMacro(e){game.lancer.prepareCoreActiveMacro(e)}_rollCorePassiveMacro(e){game.lancer.prepareCorePassiveMacro(e)}_rollActivationMacro(e,t,a){game.lancer.prepareActivationMacro(e,t,a.Type,a.Index)}}function register(e){}const l={categories:[{nestId:"pilot",id:"pilot",name:game.i18n.localize("tokenActionHud.lancer.pilot"),subcategories:[{nestId:"pilot_skill-triggers",id:"skill-triggers",name:game.i18n.localize("tokenActionHud.lancer.skillTriggers"),type:"system",hasDerivedSubcategories:!1},{nestId:"pilot_grit",id:"grit",name:game.i18n.localize("tokenActionHud.lancer.grit"),type:"system",hasDerivedSubcategories:!1},{nestId:"pilot_talents",id:"talents",name:game.i18n.localize("tokenActionHud.lancer.talents"),type:"system",hasDerivedSubcategories:!0},{nestId:"pilot_pilot-gear",id:"pilot-gear",name:game.i18n.localize("tokenActionHud.lancer.gear"),type:"system",hasDerivedSubcategories:!1},{nestId:"pilot_pilot-weapons",id:"pilot-weapons",name:game.i18n.localize("tokenActionHud.lancer.weapons"),type:"system",hasDerivedSubcategories:!1}]}],subcategories:[{id:"skill-triggers",name:game.i18n.localize("tokenActionHud.lancer.skillTriggers"),type:"system",hasDerivedSubcategories:!1},{id:"grit",name:game.i18n.localize("tokenActionHud.lancer.grit"),type:"system",hasDerivedSubcategories:!1},{id:"talents",name:game.i18n.localize("tokenActionHud.lancer.talents"),type:"system",hasDerivedSubcategories:!0},{id:"pilot-gear",name:game.i18n.localize("tokenActionHud.lancer.gear"),hasDerivedSubcategories:!1},{id:"pilot-weapons",name:game.i18n.localize("tokenActionHud.lancer.weapons"),type:"system",hasDerivedSubcategories:!1}]};class SystemManager extends o{doGetCategoryManager(){return new i}doGetActionHandler(e){return new ActionHandler(e)}getAvailableRollHandlers(){return{core:"Core Lancer"}}doGetRollHandler(e){return new RollHandler}doRegisterSettings(e){}async doRegisterDefaultFlags(){const e=l;await s.setUserFlag("default",e)}}export{ActionHandler,t as CoreActionHandler,a as CoreActionListExtender,i as CoreCategoryManager,r as CorePreRollHandler,n as CoreRollHandler,o as CoreSystemManager,s as CoreUtils,c as Logger,RollHandler,SystemManager,register};
